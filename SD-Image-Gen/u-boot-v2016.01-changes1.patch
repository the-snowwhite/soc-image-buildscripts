From cef92264ecf7b5d974601fdf00e8dd3c0899d3e2 Mon Sep 17 00:00:00 2001
From: the-snowwhite <producer@holotronic.dk>
Date: Sun, 21 Feb 2016 11:48:30 +0100
Subject: [PATCH 1/4] add fpga config on boot from socfpga.rbf in boot parttion

Signed-off-by: the-snowwhite <producer@holotronic.dk>
---
 include/configs/socfpga_de0_nano_soc.h | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/include/configs/socfpga_de0_nano_soc.h b/include/configs/socfpga_de0_nano_soc.h
index cbc7396..40af164 100644
--- a/include/configs/socfpga_de0_nano_soc.h
+++ b/include/configs/socfpga_de0_nano_soc.h
@@ -37,7 +37,7 @@
 #define CONFIG_BOOTDELAY	3
 #define CONFIG_BOOTFILE		"fitImage"
 #define CONFIG_BOOTARGS		"console=ttyS0," __stringify(CONFIG_BAUDRATE)
-#define CONFIG_BOOTCOMMAND	"run mmcload; run mmcboot"
+#define CONFIG_BOOTCOMMAND	"run fpgaconfig; run mmcload; run mmcboot"
 #define CONFIG_LOADADDR		0x01000000
 #define CONFIG_SYS_LOAD_ADDR	CONFIG_LOADADDR

@@ -57,12 +57,17 @@
 	"bootimage=zImage\0" \
 	"fdt_addr=100\0" \
 	"fdtimage=socfpga.dtb\0" \
+	"fpgaimage=socfpga.rbf\0" \
+	"fpgadata=0x2000000\0" \
+	"fpgaconfig=load mmc 0:1 ${fpgadata} ${fpgaimage};" \
+	"fpga load 0 ${fpgadata} ${filesize}\0" \
 	"bootm ${loadaddr} - ${fdt_addr}\0" \
 	"mmcroot=/dev/mmcblk0p2\0" \
 	"mmcboot=setenv bootargs " CONFIG_BOOTARGS \
 		" root=${mmcroot} rw rootwait;" \
 		"bootz ${loadaddr} - ${fdt_addr}\0" \
 	"mmcload=mmc rescan;" \
+		"load mmc 0:1 ${fpgadata} ${fpgaimage};" \
 		"load mmc 0:1 ${loadaddr} ${bootimage};" \
 		"load mmc 0:1 ${fdt_addr} ${fdtimage}\0" \

--
2.7.0


From cf6fc1667a79b5c752c078b7e0ac04c704500e35 Mon Sep 17 00:00:00 2001
From: the-snowwhite <producer@holotronic.dk>
Date: Sun, 21 Feb 2016 11:51:11 +0100
Subject: [PATCH 2/4] Change sd-card partition layout boot p1-->p2 rootfs
 p2-->p3

Signed-off-by: the-snowwhite <producer@holotronic.dk>
---
 include/configs/socfpga_de0_nano_soc.h | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/include/configs/socfpga_de0_nano_soc.h b/include/configs/socfpga_de0_nano_soc.h
index 40af164..abe5202 100644
--- a/include/configs/socfpga_de0_nano_soc.h
+++ b/include/configs/socfpga_de0_nano_soc.h
@@ -59,17 +59,17 @@
 	"fdtimage=socfpga.dtb\0" \
 	"fpgaimage=socfpga.rbf\0" \
 	"fpgadata=0x2000000\0" \
-	"fpgaconfig=load mmc 0:1 ${fpgadata} ${fpgaimage};" \
+	"fpgaconfig=load mmc 0:2 ${fpgadata} ${fpgaimage};" \
 	"fpga load 0 ${fpgadata} ${filesize}\0" \
 	"bootm ${loadaddr} - ${fdt_addr}\0" \
-	"mmcroot=/dev/mmcblk0p2\0" \
+	"mmcroot=/dev/mmcblk0p3\0" \
 	"mmcboot=setenv bootargs " CONFIG_BOOTARGS \
 		" root=${mmcroot} rw rootwait;" \
 		"bootz ${loadaddr} - ${fdt_addr}\0" \
 	"mmcload=mmc rescan;" \
-		"load mmc 0:1 ${fpgadata} ${fpgaimage};" \
-		"load mmc 0:1 ${loadaddr} ${bootimage};" \
-		"load mmc 0:1 ${fdt_addr} ${fdtimage}\0" \
+		"load mmc 0:2 ${fpgadata} ${fpgaimage};" \
+		"load mmc 0:2 ${loadaddr} ${bootimage};" \
+		"load mmc 0:2 ${fdt_addr} ${fdtimage}\0" \

 /* The rest of the configuration is shared */
 #include <configs/socfpga_common.h>
--
2.7.0


From 623d74c249cb580d3ceeaea75b620b1fc57dc780 Mon Sep 17 00:00:00 2001
From: the-snowwhite <producer@holotronic.dk>
Date: Tue, 22 Mar 2016 15:21:53 +0100
Subject: [PATCH 3/4] Change u-boot env storage to mmc fat ucoot.env file in
 part2

---
 include/configs/socfpga_de0_nano_soc.h | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/include/configs/socfpga_de0_nano_soc.h b/include/configs/socfpga_de0_nano_soc.h
index abe5202..3c71638 100644
--- a/include/configs/socfpga_de0_nano_soc.h
+++ b/include/configs/socfpga_de0_nano_soc.h
@@ -47,7 +47,13 @@
 #define CONFIG_PHY_MICREL_KSZ9031
 #endif

-#define CONFIG_ENV_IS_IN_MMC
+#define CONFIG_ENV_IS_IN_FAT
+
+#ifdef CONFIG_ENV_IS_IN_FAT
+#define FAT_ENV_INTERFACE "mmc"
+#define FAT_ENV_DEVICE_AND_PART "0:2"
+#define FAT_ENV_FILE "uboot.env"
+#endif

 /* Extra Environment */
 #define CONFIG_EXTRA_ENV_SETTINGS \
--
2.7.0


From 4c1dfe215b7e267120e56827d9e141799db8d30b Mon Sep 17 00:00:00 2001
From: the-snowwhite <producer@holotronic.dk>
Date: Tue, 22 Mar 2016 15:43:33 +0100
Subject: [PATCH 4/4] Add boot to usb option

Signed-off-by: the-snowwhite <producer@holotronic.dk>
---
 include/configs/socfpga_de0_nano_soc.h | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/include/configs/socfpga_de0_nano_soc.h b/include/configs/socfpga_de0_nano_soc.h
index 3c71638..9cc8144 100644
--- a/include/configs/socfpga_de0_nano_soc.h
+++ b/include/configs/socfpga_de0_nano_soc.h
@@ -37,7 +37,7 @@
 #define CONFIG_BOOTDELAY	3
 #define CONFIG_BOOTFILE		"fitImage"
 #define CONFIG_BOOTARGS		"console=ttyS0," __stringify(CONFIG_BAUDRATE)
-#define CONFIG_BOOTCOMMAND	"run fpgaconfig; run mmcload; run mmcboot"
+#define CONFIG_BOOTCOMMAND	"run mmcboot_cmd"
 #define CONFIG_LOADADDR		0x01000000
 #define CONFIG_SYS_LOAD_ADDR	CONFIG_LOADADDR

@@ -57,7 +57,9 @@

 /* Extra Environment */
 #define CONFIG_EXTRA_ENV_SETTINGS \
-	"loadaddr= " __stringify(CONFIG_SYS_LOAD_ADDR) "\0" \
+   "mmcboot_cmd=run mmcfpgaconfig; run mmcload; run mmcboot\0" \
+   "usbboot_cmd=usb start; run usbfpgaconfig; run usbload; run usbboot\0" \
+   "loadaddr= " __stringify(CONFIG_SYS_LOAD_ADDR) "\0" \
 	"ramboot=setenv bootargs " CONFIG_BOOTARGS ";" \
 		"bootm ${loadaddr} - ${fdt_addr}\0" \
 	"bootimage=zImage\0" \
@@ -65,17 +67,27 @@
 	"fdtimage=socfpga.dtb\0" \
 	"fpgaimage=socfpga.rbf\0" \
 	"fpgadata=0x2000000\0" \
-	"fpgaconfig=load mmc 0:2 ${fpgadata} ${fpgaimage};" \
+	"mmcfpgaconfig=load mmc 0:2 ${fpgadata} ${fpgaimage};" \
+	"fpga load 0 ${fpgadata} ${filesize}\0" \
+	"usbfpgaconfig=load usb 0:2 ${fpgadata} ${fpgaimage};" \
 	"fpga load 0 ${fpgadata} ${filesize}\0" \
 	"bootm ${loadaddr} - ${fdt_addr}\0" \
 	"mmcroot=/dev/mmcblk0p3\0" \
+	"usbroot=/dev/sda3\0" \
 	"mmcboot=setenv bootargs " CONFIG_BOOTARGS \
 		" root=${mmcroot} rw rootwait;" \
 		"bootz ${loadaddr} - ${fdt_addr}\0" \
-	"mmcload=mmc rescan;" \
+   "usbboot=setenv bootargs " CONFIG_BOOTARGS \
+		" root=${usbroot} rw rootwait;" \
+		"bootz ${loadaddr} - ${fdt_addr}\0" \
+		"mmcload=mmc rescan;" \
 		"load mmc 0:2 ${fpgadata} ${fpgaimage};" \
 		"load mmc 0:2 ${loadaddr} ${bootimage};" \
 		"load mmc 0:2 ${fdt_addr} ${fdtimage}\0" \
+   "usbload=usb reset;" \
+		"load usb 0:2 ${fpgadata} ${fpgaimage};" \
+		"load usb 0:2 ${loadaddr} ${bootimage};" \
+		"load usb 0:2 ${fdt_addr} ${fdtimage}\0" \

 /* The rest of the configuration is shared */
 #include <configs/socfpga_common.h>
--
2.7.0
